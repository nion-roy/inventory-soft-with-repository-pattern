$(document).ready(function () {
    (function ($) {
        $.ajaxSetup({
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
        });

        // Show payment history modal and fetch payment history
        $(".paymentView").click(function (e) {
            e.preventDefault();
            var orderId = $(this).attr("order-id");
            var url = "/admin/payment-history/" + orderId;

            $("#paymentHistory").modal("show");
            getPaymentHistory(url);
        });

        // Delete payment history item with AJAX
        $("#paymentHistory").on("click", ".paymentHistoryDelete", function (e) {
            e.preventDefault();
            var deleteId = $(this).attr("history-id");
            var orderId = $(this).attr("order-id");
            var url = "/admin/payment-history-delete/" + deleteId;
            var showURLID = "/admin/payment-history/" + orderId;
            $.ajax({
                type: "GET",
                url: url,
                success: function (response) {
                    toastr.success(
                        "Payment item deleted successfully",
                        "Success"
                    );
                    getPaymentHistory(showURLID);
                },
            });
        });

        // Function to fetch and render payment history
        function getPaymentHistory(url) {
            $.ajax({
                url: url,
                type: "GET",
                success: function (response) {
                    $("#payment__history__list").html(
                        response.paymentHistories
                    );
                },
            });
        }

        // Display success message from local storage if available
        var successMessage = localStorage.getItem("successMessage");
        if (successMessage) {
            toastr.options = {
                progressBar: true,
                positionClass: "toast-top-right",
                timeOut: 1000,
            };
            toastr.success(successMessage, "Success");
            localStorage.removeItem("successMessage");
        }

        //Get to payment history with order id on ajax
        $(".payement-add-button").click(function (e) {
            e.preventDefault();
            $("#addPayment").modal("show");

            var orderId = $(this).attr("order-id");
            var url = "/admin/payment-history-order/" + orderId;

            $.ajax({
                url: url,
                type: "GET",
                success: function (response) {
                    // console.log(response.historyLatest);
                    $("#total_amount").val(response.historyLatest.due_amount);
                    $("#paymentNow").attr(
                        "order-id",
                        response.historyLatest.order_id
                    );
                },
            });
        });
        //Get to payment history with order id on ajax

        // Function to calculation
        $("#paying_amount").on("input", function () {
            var totalAmount = parseFloat($("#total_amount").val());
            var payingAmount = parseFloat($("#paying_amount").val());
            var dueAmount = totalAmount - payingAmount;
            if (payingAmount) {
                $("#due_amount").val(dueAmount);
            } else {
                $("#due_amount").val(totalAmount);
            }
        });
        // Function to calculation

        // New payment added to user in order
        $("#paymentNow").click(function (e) {
            e.preventDefault();

            var orderID = $(this).attr("order-id");
            var url = "/admin/payment-add/" + orderID;
            // alert(orderID);

            // Clear previous error messages
            $(".is-invalid").removeClass("is-invalid");
            $(".invalid-feedback").remove();

            var formData = {
                customer_id: $("#customer_id").val(),
                order_id: $("#order_id").val(),
                total_amount: $("#total_amount").val(),
                paying_amount: $("#paying_amount").val(),
                due_amount: $("#due_amount").val(),
                payment_type: $("#payment_type").val(),
                payment_note: $("#payment_note").val(),
                sale_note: $("#sale_note").val(),
            };

            $.ajax({
                url: url,
                type: "POST",
                data: formData,
                success: function (response) {
                    // alert(response);
                    localStorage.setItem(
                        "successMessage",
                        "New payment added successfully."
                    );
                    window.location.href = window.location.href;
                },
                error: function (xhr, status, error) {
                    var errors = xhr.responseJSON;
                    $.each(errors.errors, function (key, value) {
                        $("#" + key).addClass("is-invalid");
                        $("#" + key).after(
                            '<span class="invalid-feedback text-danger">' +
                                value[0] +
                                "</span>"
                        );
                    });
                },
            });
        });
        // New payment added to user in order
    })(jQuery);
});
